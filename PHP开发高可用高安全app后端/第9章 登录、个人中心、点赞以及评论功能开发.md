# 登录、个人中心、点赞以及评论功能开发

处理App的登录功能是小伙伴们都会恼火的事情。本章的逻辑全是登录状态下内容，首先分析登录业务，接着讲解web登录和APP登录的异同之处；登录中引入了阿里大于验证码机制,并且对阿里大于SDK进行高度的封装同事引入PHP设计模式讲解；在登录下的API中，我们采用access_user_token算法机制，来验证登录身份，在获取评论列表的地...

## App登录业务介绍

### 为什么要做登录

- 挖掘用户
- 互动、交流

### 如何去做

- 模仿（模仿业界成熟的方案）

短信验证码登录、注册账号登录、通过第三方登录

## App登录表结构的设计

表名：inter_user 用户表

- id 用户唯一标识id号
- username 用户名 
- password 密码 （md5加密）
- phone 手机号
- token 用户的token值 （app登录时需要）
- time_out token  失效时间
- image 用户头像
- sex 用户性别（默认值为：0）
- signature 用户签名
- status 状态
- create_time 发布时间
- update_time 修改时间

## 阿里大于云通信服务平台介绍

### 什么是阿里大于

- 阿里大于提供包括短信、语音等个性化的服务

### 短信申请步骤

- 打开阿里大于登录账号，进入控制台
- 充值金额
- 创建应用（需要使用应用对应的app key，和app secret）
- 添加签名（短信的头名称）
- 配置短信模块，添加模板（短信内容格式）

## 打造属于适配TP5模式的阿里大于

### 获取SDK

- 进入控制台，SDK下载
- 下载到本地，复制里面的文件

### 将SDK安装到哪

- 粘贴放入 `extend/ali` 下（需要先创建ali文件夹）

### SDK需要适配TP5

- 打开 `aliyun/AliyunClient.php` 添加对应的域名空间：

```php
namespace ali\aliyun;
```

- 下面用到的包文件同理添加对应的自己的命名空间，如果其他文件用到另外的文件的话需要使用 `use ... ` 
- 不好查找，可以使用的时候用到的话就添加

## 编写第一个发送短信demo

在 `app/api/controller/Test.php` 文件中，添加一个方法测试短信接口是否能够使用： 

```php
// 引入TopClient
use ali\aliyun\top\TopClient;

public function sendSms(){
	$c = new TopClient();
	$c->appkey = "23696697"; // 可替换为您的沙箱环境应用的AppKey
	$c->secretKey = "d44401c13bc6b66f23555a086b2485d2"; // 可替换为您的沙箱环境应用的AppSecret
	$req = new AlibabaAliqinFcSmsNumSendRequest();
	$req->setExtend("123456");
	$req->setSmsType("json");
	$req->setSmsFreeSignName("签名的名称"); // 短信的模板签名
	$req->setSmsParam("{\"number\":\"验证码\"}"); // 短信需要用到的参数
	$req->setRecNum("手机号");
	$req->setSmsTemplateCode("SMS_135365108"); // 短信的模板编号
	$resp = $c->execute($req);
	halt($resp);
}
```

发送后，可以通过阿里大于控制台查看短信发送数据

## 代码高度复用-发送短信类库封装(一)

使用单例模式封装，单例模式的三个条件：

- 拥有一个构造函数，并且该函数是私有函数，其他不能使用
- 拥有一个保存类的实例的静态成员变量
- 拥有一个访问这个实例的公共的静态方法

创建一个阿里大于文件 `common/lib/Alidayu.php` ：

```php
<?php
namespace app\common\lib;
use ali\top\TopClient;
use ali\top\request\AlibabaAliqinFcSmsNumSendRequest;
/**
 * 阿里大于发送短信基础类库
 * Class Alidayu
 * @package app\common\lib
 */
class Alidayu {
    /**
     * 2.静态变量保存全局的实例
     * @var null
     */
    private static $_instance = null;

    /**
     * 1.私有的构造方法
     */
    private function __construct() {

    }

    /**
     *3. 静态方法 单例模式统一入口 资源不浪费
     */
    public static function getInstance() {
		// 如果不存在则实例化
        if(is_null(self::$_instance)) {
            self::$_instance = new self();
        }
        return self::$_instance;
    }

    /**
     * 设置短信验证
     * @param int $phone
     * @return bool
     */
    public function setSmsIdentify($phone = 0) {
        //生成验证码随机数
        $code = rand(1111, 9999);

        try {
            $c = new TopClient;
            $c->appkey = config('aliyun.appKey');
            $c->secretKey = config('aliyun.secretKey');
            $req = new AlibabaAliqinFcSmsNumSendRequest;
            $req->setExtend("123456");
            $req->setSmsType("normal");
            $req->setSmsFreeSignName(config('aliyun.signName'));
            $req->setSmsParam("{\"number\":\"" . $code . "\"}");
            $req->setRecNum($phone);
            $req->setSmsTemplateCode(config('aliyun.templateCode'));
            $resp = $c->execute($req);
        }catch (\Exception $e) {
            return false;
        }

        if($resp->result->success == "true") {
            return true;
        }
        return false;
    }
}
```

创建阿里大于的配置文件 `app/extra/aliyun.php` ：

```php
<?php
/**
 * 阿里云相关的配置
 */
return [
    'appKey' => '24528979',
    'secretKey' => 'ec6d90dc7e93b4cc824183f71710e1ee',
    'signName' => 'singwa娱乐app', // 签名
    'templateCode' => 'SMS_75915048', // 模板编号
];
```

在 `Test.php` 文件中创建方法调用短信类库：

```php
use app\common\lib\Alidayu;
public function testsend() {
	Alidayu::getInstance()->setSmsIdentify('手机号');
}
```

如果报Exception的错，可能是因为下载的文件用的 `new Exception` 中的 ‘\’ 导致，找到文件修改为 `new \Exception` 即可

## 代码高度复用-发送短信类库封装(二)

在 `common/lib/Alidayu.php` 中引入失效文件和日志文件：

```php
use think\Cache;
use think\Log;
```

在 `common/lib/Alidayu.php` 中的setSmsIdentify() 方法中增加验证码失效时间：

```php
	// 定义日志常量
    const LOG_TPL = "alidayu:";
    /**
     * 设置短信验证
     * @param int $phone
     * @return bool
     */
    public function setSmsIdentify($phone = 0) {
		...

        try {
            ...
        }catch (\Exception $e) {
            // 记录日志
            Log::write(self::LOG_TPL."set-----".$e->getMessage());
            return false;
        }
        if($resp->result->success == "true") {
            // 设置验证码失效时间
            Cache::set($phone, $code, config('aliyun.identify_time'));
            return true;
        }else {
			// 记录日志
            Log::write(self::LOG_TPL."set-----111" . json_encode($resp));
        }
        return false;
    }
```

在 `app/extra/aliyun.php` 配置中增加失效时间：

```php
return [
    ...
    'identify_time' => 12000000,
];
```

在 `common/lib/Alidayu.php` 中增加判断验证码是否已经失效的方法：

```php
    /**
     * 根据手机号码查询验证码是否已经是失效
     * @param int $phone
     */
    public function checkSmsIdentify($phone = 0) {
        if(!$phone) {
            return false;
        }
        return Cache::get($phone);
    }
```

日志文件记录在 `runtime/log` 中

## 代码高度复用-发送短信类库封装(三)

完善下 `TopClient.php` 文件中的TOP_SDK_WORK_DIR未定义：

在 `app/extra/aliyun.php` 配置中增加配置信息：

```php
return [
    ...
    'identify_time' => 12000000,
    'top_sdk_work_dir' => '/tmp/',
];
```

把阿里大于的 `topClient.php` 文件中的TOP_SDK_WORK_DIR(这个没有定义)修改成config('aliyun.top_sdk_work_dir')：

```php
protected function logCommunicationError($apiName, $requestUrl, $errorCode, $responseTxt)
{
	$localIp = isset($_SERVER["SERVER_ADDR"]) ? $_SERVER["SERVER_ADDR"] : "CLI";
	$logger = new TopLogger;
	$logger->conf["log_file"] = rtrim(config('aliyun.top_sdk_work_dir'), '\\/') . '/' . "logs/top_comm_err_" . $this->appkey . "_" . date("Y-m-d") . ".log";
	···
}
public function execute($request, $session = null,$bestUrl = null)
{
	···
	//如果TOP返回了错误码，记录到业务错误日志中
	if (isset($respObject->code))
	{
		$logger = new TopLogger;
		$logger->conf["log_file"] = rtrim(config('aliyun.top_sdk_work_dir'), '\\/') . '/' . "logs/top_biz_err_" . $this->appkey . "_" . date("Y-m-d") . ".log";
		$logger->log(array(
			date("Y-m-d H:i:s"),
			$resp
		));
	}
	return $respObject;
}
```

## 发送短信验证码功能开发

设置路由 `app/route.php` ：

```php
//短信验证码相关
Route::resource('api/:ver/identify', 'api/:ver.identify');
```

创建文件 `app/api/controller/v1/Identify.php`，设置短信验证码：

```php
<?php
namespace app\api\controller\v1;

use app\api\controller\Common;
use think\Controller;
use app\common\lib\exception\ApiException;
use app\common\lib\Alidayu;

class Identify extends Common {
    /**
     * 设置短信验证码 post
     */
    public function save() {
        if(!request()->isPost()) {
            return show(config('code.error'), '您提交的 数据不合法', [], 403 );
        }

        // 检验数据
        $validate = validate('Identify');
        if(!$validate->check(input('post.'))) {
            return show(config('code.error'), $validate->getError(), [], 403);
        }

        $id = input('param.id'); // id表示传递的手机号
		// 调用阿里大于上几步封装好的方法，不要忘了引入文件
        if(Alidayu::getInstance()->setSmsIdentify($id)) {
            return show(config('code.success'), 'OK', [], 201);
        }else {
            return show(config('code.error'), "error", [], 403);
        }
    }
}
```

新建一个检验文件 `app/common/validate/Identify.php`：

```php
namespace app\common\validate;
use think\Validate;
class Identify extends Validate {
    protected $rule = [
        'id' => 'require|number|length:11',
    ];
}
```

## APP登录之短信验证码方式登录(一)

### APP登录和web登录的区别

- App
	- phpsessionid
	- 优点：流畅、稳定、基本上一些App都可以脱网运行、用户体验好
	- 缺点：不能跨平台
- Web 
	- token(唯一性)，在登录状态下 所有的请求必须带token, token-》失效时间
	- 优点：可以跨平台 
	- 缺点：没有App流畅、不稳定（受限于网速和网络）
	
### 用户第一次登录

注册用户信息，然后登录成功

### 系统中存在该手机号码的用户登录

已经存在之后，直接登录，然后更新相对应的数据

## APP登录之token唯一性算法（二）

创建设置登录token的方法 `app/common/validate/IAuth.php` ：

```php
/**
 * 设置登录的token  - 唯一性的
 * @param string $phone
 * @return string
 */
public  static function setAppLoginToken($phone = '') {
	$str = md5(uniqid(md5(microtime(true)), true));
	$str = sha1($str.$phone);
	return $str;
}
```

在 `Test.php` 文件中创建方法调用token的值：

```php
public function token() {
	echo IAuth::setAppLoginToken();
}
```

## APP登录-短信验证码方式登录(三)

创建路由：

```php
// 登录的路由
Route::post('api/:ver/login', 'api/:ver.login/save');
```

创建login文件：

```php
<?php
namespace app\api\controller\v1;

use app\api\controller\Common;
use think\Controller;
use app\common\lib\exception\ApiException;
use app\common\lib\Aes;

class Login extends Common {

    public function save() {
        if(!request()->isPost()) {
            return show(config('code.error'), '您没有权限', '', 403);
        }

        $param = input('param.');
        if(empty($param['phone'])) {
            return show(config('code.error'), '手机不合法', '', 404);
        }
        if(empty($param['code']) && empty($param['password'])) {
            return show(config('code.error'), '手机短信验证码或者密码不合法', '', 404);
        }

        if(!empty($param['code'])) {
            //  validate 严格校验
            $code = Alidayu::getInstance()->checkSmsIdentify($param['phone']);
            if ($code != $param['code']) {
                return show(config('code.error'), '手机短信验证码不存在', '', 404);
            }
        }

        $token = IAuth::setAppLoginToken($param['phone']);
        $data = [
            'token' => $token,
            'time_out' => strtotime("+".config('app.login_time_out_day')." days"),
        ];

        // 查询这个手机号是否存在
        $user = User::get(['phone' => $param['phone']]);
        if($user && $user->status == 1) {
            if(!empty($param['password'])) {
                // 判定用户的密码 和 $param['password'] 加密之后
                if(IAuth::setPassword($param['password']) != $user->password) {
                    return show(config('code.error'), '密码不正确', [], 403);
                }
            }
            $id = model('User')->save($data, ['phone' => $param['phone']]);
        } else {
            if(!empty($param['code'])) {
                // 第一次登录 注册数据
                $data['username'] = 'singwa粉-' . $param['phone'];
                $data['status'] = 1;
                $data['phone'] = $param['phone'];//1caee2c8012cf16f5c2a6e151cd91442714c720b
                //45077d10c31a2ea59eb785020625101e695d3d20

                $id = model('User')->add($data);
            } else {
                return show(config('code.error'), '用户不存在', [], 403);
            }
        }//sA9YGeyzYJmjHgS0lUfKqYwPQR0SPwLQ1Pp1/iPZcL1x1o877quF3iwPjtpQBFGl

        $obj = new Aes();
        if($id) {
            $result = [
                'token' => $obj->encrypt($token."||".$id),
            ];
            return show(config('code.success'), 'ok', $result);
        }else {
            return show(config('code.error'), '登录失败', [], 403);
        }
    }

}
```

配置token的失效时间 `app/extra/app.php`：

```php
 'login_time_out_day' => 7,// 登录token的失效时间
```

## APP登录安全性保障(四)

## 权限控制详解

## access_user_token安全性问题思考

## 个人中心-获取用户基本信息数据

## 个人中心-设置个人头像接口开发

## 个人中心-其他基本信息修改

## 个人中心 - 个人密码设置

## APP登录-按密码方式登录

## 登录、个人中心设置等APP调试

## 点赞表的设计

## 点赞功能开发

## 取消点赞功能开发

## 获取文章是否被点赞

## 评论表的设计

## 评论功能开发

## 评论列表API开发之原生关联查询MySQL语句解剖

## 评论列表API开发之关联连表查询

## 评论列表API开发之优化方案

## 点赞评论等APP调试