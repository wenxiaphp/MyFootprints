
## 验证码功能开发

### ThinkPHP5验证码的巧妙使用

1、登录

	首先在admin中的controller中创建Login.php，定位到首页
```php
public function index(){
	return $this->fetch();
}
```	
	进入验证码类库vendor/topthink/think-captcha
	访问地址：域名/index.php/captcha （如果index.php隐藏的话可以省略）
	找到admin/login/index.html中插入验证码
```html
// 插入图片点击刷新
	<img src="/captcha" alt='验证码' onclick="reloadCode(this)">
```

```css
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="/captcha?id" + Math.random;
	}
</script>
```

	配置验证码的宽高：config.php 中 增加：
```php
'captcha' => [
	'imageH' => 50,
	'imageW' => 200
],
```

### 如何点击验证码图片自动刷新验证码 

	获取验证码进行匹配
```html
// 点击登录提交的模板
<form class='' action="{:url('login/check')}" method='post'>
</form>
```

```php
publuc function check(){
	$data = input('post.');
	if(!captcha_check($data['code'])){
		$this->error("验证码不正确");
	}
}
```

## 登录功能开发

流程：验证码判断 -> 基本信息判定 -> 登录成功/登录失败

```php
// 登录相关业务
publuc function check(){
	if(request()->isPost()){
		$data = input('post.');
		if(!captcha_check($data['code'])){
			$this->error("验证码不正确");
		}
		// 判断信息 username password
		// validate 机制 
		// username 用户名存在与否
		// username+password 用户名或密码错误
		$user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
		// halt($user);
		if(!$user || $user->status != 1){
			$this->error("用户名不存在");
		}
		// 根据添加数据的时候加密方式进行判断密码
		if(md5($data['password'].'_#sing_ty') != $user['password']){
			$this->error("密码不正确");
		}
		
		
	}else{
		$this->error("请求方法不正确");
	}
}
```

 

