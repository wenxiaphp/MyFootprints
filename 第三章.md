
## 验证码功能开发

### ThinkPHP5验证码的巧妙使用

1、登录

	首先在admin中的controller中创建Login.php，定位到首页
```php
// 登录页面
public function index(){
	return $this->fetch();
}
```	
	
	进入验证码类库vendor/topthink/think-captcha
	找到admin/login/index.html中插入验证码
	
```html
// 方式一： 插入图片点击刷新
<img src="/captcha" alt='验证码' onclick="reloadCode(this)">
// 方式一对应的事件
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="/captcha?id" + Math.random;
	}
</script>

//方式二： 如果上述拿不到图片使用这个：
<img src="{:captcha_src()}" alt='验证码' onclick="reloadCode(this)">
// 方式二对应的事件
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="{:captcha_src()}" + Math.random;
	}
</script>

// 方式三：对应事件直接写在标签里面
<img src="{:captcha_src()}" onclick="this.src='{:captcha_src()}?'+Math.random();" />
```

	配置验证码的宽高：app/config.php 中 增加：
```php
'captcha' => [
	'imageH' => 50,
	'imageW' => 200
],
```

### 如何点击验证码图片自动刷新验证码 

	获取验证码进行匹配
```html
// 点击登录提交的模板
<form class='' action="{:url('login/check')}" method='post'>
</form>
```

```php
publuc function check(){
	$data = input('post.');
	if(!captcha_check($data['code'])){
		$this->error("验证码不正确");
	}
}
```

## 登录功能开发

流程：验证码判断 -> 基本信息判定 -> 登录成功/登录失败

```php
// 登录相关业务
publuc function check(){
	if(request()->isPost()){
		$data = input('post.');
		if(!captcha_check($data['code'])){
			$this->error("验证码不正确");
		}
		// 判断信息 username password
		// validate 机制 
		// username 用户名存在与否
		// username+password 用户名或密码错误
		$user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
		// halt($user);
		if(!$user || $user->status != 1){
			$this->error("用户名不存在");
		}
		// 根据添加数据的时候加密方式进行判断密码
		if(md5($data['password'].'_#sing_ty') != $user['password']){
			$this->error("密码不正确");
		}
	}else{
		$this->error("请求方法不正确");
	}
}
```

5： 把密码加密信息放到配置文件中
'_#sing_ty' 为了一后方便设置更改，设置配置文件，app/extra/app.php

```php
return [
    'password_pre_halt' => '_#sing_ty', // 密码加密
];
```

6： 封装类库  把md5加密封装到 IAuth.php 中，同时设置加密配置常量
新建文件common/lib/IAuth.php
```php
namespace app\common\lib;
/**
 * IAuth 相关
 * Class IAuth
 * @package app\common\lib
 */
class IAuth{

    /**
     * Notes: 设置密码
     * @param $data
     * @return string
     */
    public function setPassword($data)
    {
        //return md5($data . '_#sing_ty');
				5： 把密码加密信息放到配置文件中
				return md5($data . config("app.password_pre_halt"));
    }
}
```

7： 更新数据库 登录时间 登录ip地址
8： 完善try{}catch(){}
9： 更新 session
10： 把状态码信息方到配置文件中
新建配置文件 app/extra/code.php

```php
/**
 * 和状态码先关的文案配置
 */
return [
    'status_deleta' => '-1',
    'status_normale' => '1',
    'status_padding' => '0',// 待审
];
```

11：把session存储信息放到配置文件中
新建配置文件 app/extra/admin.php

```php
/**
 * session存储的文案配置
 */
return [
    'session_user' => 'adminuser',
    'status_user_scope' => 'imooc_app_scope',
];
```

最终：

```php
// 登录相关业务
    public function check(){
        if(request()->isPost()){
            $data = input('post.');
            if(!captcha_check($data['code'])){
                $this->error("验证码不正确");
            }
            // 判断信息 username password
            // validate 机制
            // username 用户名存在与否
            // username+password 用户名或密码错误

            // 8： 判断try{}catch(){}
            try {
                $user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
            }catch (\Exception $e){
                $this->error($e->getMessage());
            }
            // halt($user);
            // 10： 把状态码信息方到配置文件中
            if(!$user || $user->status != config('code.status_normal')){
                $this->error("用户名不存在");
            }
            // 根据添加数据的时候加密方式进行判断密码
            // 6： 封装类库 把md5加密封装到 IAuth.php 中，同时设置加密配置常量
            if(IAuth::setPassword($data['password']) != $user['password']){
                $this->error("密码不正确");
            }
            // 7： 更新数据库 登录时间 登录ip地址
            $updata = [
                'last_login_time'=> time(),
                'last_login_ip' => request()->ip(),
            ];
            try{
                model("AdminUser")->save($updata,['id'=>$user->id]);
            }catch (\Exception $e){
                $this->error($e->getMessage());
            }
            // 9： 更新 session
            // 11： 吧session放入文案中
            session(config('admin.session_user'),$user,config('admin.session_user_scope'));
            $this->success("登录成功","index/index");
        }else{
            $this->error("请求方法不正确");
        }
    }
```


退出：
1、清空session
2、跳转页面

```php
/**
 * Notes: 退出登录逻辑
 * 1、清空session
 * 2、跳转页面
 */
public function logOut(){
		session(null,config('admin.session_user_scope'));
		$this->redirect("login/index");
}
```

查看session是否清空

```php
halt(session(config('admin.session_user'),'',config('admin.session_user_scope')));
```