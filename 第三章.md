3.3-3.6
## 验证码功能开发

### ThinkPHP5验证码的巧妙使用

1、登录

- 首先在admin中的controller中创建Login.php，定位到首页
	
```php
// 登录页面
public function index(){
	return $this->fetch();
}
```	
	
- 进入验证码类库vendor/topthink/think-captcha

- 找到admin/login/index.html中插入验证码
	
```html
// 方式一： 插入图片点击刷新
<img src="/captcha" alt='验证码' onclick="reloadCode(this)">
// 方式一对应的事件
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="/captcha?id" + Math.random;
	}
</script>

//方式二： 如果上述拿不到图片使用这个：
<img src="{:captcha_src()}" alt='验证码' onclick="reloadCode(this)">
// 方式二对应的事件
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="{:captcha_src()}" + Math.random;
	}
</script>

// 方式三：对应事件直接写在标签里面
<img src="{:captcha_src()}" onclick="this.src='{:captcha_src()}?'+Math.random();" />
```

- 配置验证码的宽高：app/config.php 中 增加：
	
```php
'captcha' => [
	'imageH' => 50,
	'imageW' => 200
],
```

### 如何点击验证码图片自动刷新验证码 

- 获取验证码进行匹配

```html
// 点击登录提交的模板
<form class='' action="{:url('login/check')}" method='post'>
</form>
```

- 对应的服务端设置

```php
publuc function check(){
	$data = input('post.');
	if(!captcha_check($data['code'])){
		$this->error("验证码不正确");
	}
}
```

## 登录功能开发

【注意】
- 下面的序号表示对应的最终login方法中的序号，可以查看对应的代码更改
- 该model对应的文件名，同时是去掉前缀的数据库的名称，如果碰到下划线则下划线后面一个词首字母大写

流程：验证码判断 -> 基本信息判定 -> 登录成功/登录失败

```php
// 登录相关业务
publuc function check(){
	if(request()->isPost()){
		$data = input('post.');
		if(!captcha_check($data['code'])){
			$this->error("验证码不正确");
		}
		// 判断信息 username password
		// validate 机制 
		// username 用户名存在与否
		// username+password 用户名或密码错误
		$user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
		// halt($user);
		if(!$user || $user->status != 1){
			$this->error("用户名不存在");
		}
		// 根据添加数据的时候加密方式进行判断密码
		if(md5($data['password'].'_#sing_ty') != $user['password']){
			$this->error("密码不正确");
		}
	}else{
		$this->error("请求方法不正确");
	}
}
```

5： 把密码加密信息放到配置文件中
'_#sing_ty' 为了一后方便设置更改，设置配置文件，app/extra/app.php

```php
return [
    'password_pre_halt' => '_#sing_ty', // 密码加密
];
```

6： 封装类库  把md5加密封装到 IAuth.php 中，同时设置加密配置常量
新建文件common/lib/IAuth.php
```php
namespace app\common\lib;
/**
 * IAuth 相关
 * Class IAuth
 * @package app\common\lib
 */
class IAuth{

    /**
     * Notes: 设置密码
     * @param $data
     * @return string
	 * 如果不加static，可能报错：... should not be called statically
     */
    public static function setPassword($data)
    {
        //return md5($data . '_#sing_ty');
		5： 把密码加密信息放到配置文件中
		return md5($data . config("app.password_pre_halt"));
    }
}
```

7： 更新数据库 登录时间 登录ip地址

8： 完善try{}catch(){}

9： 更新 session

10： 把状态码信息方到配置文件中

新建配置文件 app/extra/code.php

```php
/**
 * 和状态码先关的文案配置
 */
return [
    'status_deleta' => '-1',
    'status_normale' => '1',
    'status_padding' => '0',// 待审
];
```

11：把session存储信息放到配置文件中

新建配置文件 app/extra/admin.php

```php
/**
 * session存储的文案配置
 */
return [
    'session_user' => 'adminuser',
    'session_user_scope' => 'imooc_app_scope',
];
```

最终：

```php
// 登录相关业务
    public function check(){
        if(request()->isPost()){
            $data = input('post.');
            if(!captcha_check($data['code'])){
                $this->error("验证码不正确");
            }
            // 判断信息 username password
            // validate 机制
            // username 用户名存在与否
            // username+password 用户名或密码错误

            // 8： 判断try{}catch(){}
            try {
                $user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
            }catch (\Exception $e){
                $this->error($e->getMessage());
            }
            // halt($user);
            // 10： 把状态码信息方到配置文件中
            if(!$user || $user->status != config('code.status_normal')){
                $this->error("用户名不存在");
            }
            // 根据添加数据的时候加密方式进行判断密码
            // 6： 封装类库 把md5加密封装到 IAuth.php 中，同时设置加密配置常量
            if(IAuth::setPassword($data['password']) != $user['password']){
                $this->error("密码不正确");
            }
            // 7： 更新数据库 登录时间 登录ip地址
            $updata = [
                'last_login_time'=> time(),
                'last_login_ip' => request()->ip(),
            ];
            try{
                model("AdminUser")->save($updata,['id'=>$user->id]);
            }catch (\Exception $e){
                $this->error($e->getMessage());
            }
            // 9： 更新 session
            // 11： 吧session放入文案中
            session(config('admin.session_user'),$user,config('admin.session_user_scope'));
            // $this->success("登录成功","index/index");
			$this->redirect('index/index');
        }else{
            $this->error("请求方法不正确");
        }
    }
```


## 退出：

1、清空session

2、跳转页面

```php
/**
 * Notes: 退出登录逻辑
 * 1、清空session
 * 2、跳转页面
 */
public function logOut(){
		session(null,config('admin.session_user_scope'));
		$this->redirect("login/index");
}
```

查看session是否清空

```php
halt(session(config('admin.session_user'),'',config('admin.session_user_scope')));
```

3.7
## 权限控制

在控制器中创建一个基类：admin/controller/Base.php

```php
namespace app\admin\controller;
use think\Controller;
class Base extends Controller{
    /**
     * Notes:初始化方法
     */
    public function _initialize(){
        // 判定用户是否登录
        $isLogin = $this->isLogin();
        if(!$isLogin){
            return $this->redirect("login/index");
        }
    }

    /**
     * Notes: 判定是否登录
     * @return bool
     */
    public function isLogin(){
        //获取session值
        $user = session(config("admin.session_user"),'',config('admin.session_user_scope'));
        if($user && $user->id){
            return true;
        }else{
            return false;
        }
    }
}
```

更新登录控制器，继承 Base ，同时更新 index 方法、重定义 _initialize() 方法

其他控制器需要判断是否登录过的话，都需要去继承 Base

```php
class Login extends Base
{
	// 如果不从定义的话，因为继承 Base 控制器会导致死循环
	public function _initialize() {
	}
	// 登录页面
	public function index(){
		$isLogin = $this->isLogin();
		if(!$isLogin) {
			return $this->redirect('index/index');
		}else {
			// 如果后台用户已经登录了， 那么我们需要跳到后台页面
			return $this->fetch();
		}
	}
}
```	

# 四、娱乐新闻内容管理

## 表的设计

- id id值
- title 标题
- small_title 短标题
- catid 栏目id
- image 新闻图片地址
- content 内容 text
- description 描述
- is_position 是否推荐 默认0不推荐
- is_head_flgure 是否推荐到轮播图中 默认0不推荐
- is_allowcomments  文章是否允许被评论 默认0不允许
- listorder 排序
- source_type 新闻来源 默认0
- create_time 创建时间
- updata_time 更新时间
- status 状态 默认0

## 上传图片插件准备工作

- 第三方插件：uploadify
- 根据 uploadify 封装 js类库 - image.js

通过百度进入uploadify官网 查看用法

### 引入 uploadify 插件

1、创建一个视图文件 news 包含添加文件add.html 和 index.html

2、创建一个 News 控制器News.php

3、对应的菜单模块里面增加新闻管理, 包含添加管理，连接到：{:url('news/add')}

4、创建类库image.js：路径：public/static/admin/js/image.js

5、下载uploadify放入public/static/admin下

```html
// 使用uploadify 中的按钮样式，在文件_meta的文件中，引入uploadify的css文件
<link rel="stylesheet" type="text/css" href="__STATIC__/admin/uploadify/uploadify.css" />
// 在文件_meta的文件中，定义变量，创建image.js时使用
<script>
	swf = '__STATIC__/admin/uploadify/uploadify.swf';
	image_upload_url = "{:url('image/upload')}";
</script>
```

```js
// image.js 文件内容
$(function() {
	// 对应图片点击按钮的id名称 <input id="file_upload" type="file" multiple="true">
    $("#file_upload").uploadify({
        swf           : swf, //  指的是uploadify下的swf文件：uploadify.swf
        uploader      : image_upload_url, // 上传的路径
        buttonText    : '图片上传', // 按钮的名称
        fileTypeDesc  : 'Image files', // 文件类型描述
        fileObjName   : 'file', // 文件名称
        fileTypeExts  : '*.gif;*.jpg;*.png', // 上传文件类型
        onUploadSuccess : function(file, data, response) { // 上传成功返回数据
            // 我们需要扩展内容
            if(response) {
                var obj = JSON.parse(data); // 返回的json数据，进行json解析
                $('#upload_org_code_img').attr("src", obj.data); // 插入页面中，待展示
                $('#file_upload_image').attr("value", obj.data); // 插入页面中，待提交使用
                $('#upload_org_code_img').show(); // 上传图片显示缩略图
            }
        }
    });
});
```

后台图片上传相关逻辑

```php
namespace app\admin\controller;
class Image extends Base
{
    public function upload(){
		//后台图片上传相关逻辑
        $data = [
            'status' => 1,
            'message' => 'OK',
            'data' => 'http://t2.hddhhn.com/uploads/tu/201707/571/106.jpg',
        ];
        echo json_encode($data);
    }
}
```

### 上传到本地


上传本地的缺点：

- 不利于维护和管理
- 访问量多的时候IO操作可能会存在瓶颈
- 针对用户量不是太多，访问量不是很大

```php
namespace app\admin\controller;
use think\Request;
class Image extends Base
{
	/**
     * 图片上传
     */
    public function upload() {
        $file = Request::instance()->file('file');
        // 把图片上传到指定的文件夹中
        $info = $file->move('upload');
		// $info->getPathname() 文件上传之后返回的路径 
        if($info && $info->getPathname()) {
            $data = [
                'status' => 1,
                'message' => 'OK',
                'data' => '/thinkphp/public/'.$info->getPathname(),// 当前文件路径，不是网上的，提交时要用
            ];
            echo json_encode($data);
        }else{
            echo json_encode(['status' => 0, 'message' => '上传失败']);
        }
    }
}
```

### 图片上传到七牛云

1、添加对象存储管理（名称：myFile，访问控制：公开空间）

2、两种方式安装：

- 通过点击[下载源码](https://github.com/qiniu/php-sdk)下载之后放入vendor文件下：vendor/qiniu
- 通过Composer直接安装，[七牛云通过comooser安装连接](https://developer.qiniu.com/kodo/sdk/1241/php)

3、基于七牛云sdk封装适合TP5的图片上传类库

- 创建类库 app/common/lib/Upload
- 引入七牛鉴权类：use Qiniu\Auth;
- 引入七牛上传类：use Qiniu\Storage\UploadManager;
- 创建配置文件：extra/qiniu.php;
- 

配置文件：

```php
return [
	// 七牛云个人中心-> 秘钥管理 -> AK 和 SK
    'ak' => '自己的账号AK',
    'sk' => '自己的账号AK',
    'bucket' => '自己创建的对象存储的空间名称', // 存储空间名称
    'image_url' => 'http://otwueljs0.bkt.clouddn.com', // 存储空间名称对应的测试域名
];
```

创建类库：

```php
namespace app\common\lib;

//引入鉴权类
use Qiniu\Auth;
//引入上传类
use Qiniu\Storage\UploadManager;

/**
 * 七牛图片基础类库
 * Class Upload
 * @package app\common\lib
 */
class Upload {

    /**
     * 图片上传
     */
    public static function image() {
		// 查看图片是否传递过来
		// halt($_FILES['file']);
        if(empty($_FILES['file']['tmp_name'])) {
            exception('您提交的图片数据不合法', 404);
        }
        // 要上传的文件的
        $file = $_FILES['file']['tmp_name'];

		// 图片格式类型
        /*$ext = explode('.', $_FILES['file']['name']);
		$ext = $ext[1];*/
		// 使用php内置函数，pathinfo获取图片信息，从而获取该上传图片的图片格式
        $pathinfo = pathinfo($_FILES['file']['name']);
        //halt($pathinfo);
        $ext = $pathinfo['extension'];

		// 引入配置文件
        $config = config('qiniu');
        // 构建一个鉴权对象
        $auth  = new Auth($config['ak'], $config['sk']);
        //生成上传的token
        $token = $auth->uploadToken($config['bucket']);
        // 上传到七牛后保存的文件名
        $key  = date('Y')."/".date('m')."/".substr(md5($file), 0, 5).date('YmdHis').rand(1111, 9999).'.'.$ext;

        //初始UploadManager类
        $uploadMgr = new UploadManager();
		// list()把数组中的值赋给一些变量
        list($ret, $err) = $uploadMgr->putFile($token, $key, $file);

        if($err !== null) {
            return null;
        } else {
            return $key;
        }
    }
}
```

上传：

```php
namespace app\admin\controller;
use think\Controller;
use app\common\lib\Upload;
class Image extends Base
{
    /**
     * 七牛图片上传
     */
    public function upload() {
        try {
			// 上传到封装的upload类中
            $image = Upload::image();
        }catch (\Exception $e) {
            echo json_encode(['status' => 0, 'message' => $e->getMessage()]);
        }
        if($image) {
            $data = [
                'status' => 1,
                'message' => 'OK',
                'data' => config('qiniu.image_url').'/'.$image,
            ];
            echo json_encode($data);exit;
        }else {
            echo json_encode(['status' => 0, 'message' => '上传失败']);
        }
    }
}
```

## 内容的添加

### 入库操作方法封装，js提交添加的内容

提交数据时，分类栏目要有选项，选项内容暂时添加在 cat.php 文件中，路径为：/app/extra/cat.php，内容如下：

```php
<?php
	return [
		'lists' => [
			1 => '综艺',
			2 => '明星',
			3 => '韩娱',
			4 => '看点',
			5 => '体育',
			6 => '科技'
		]
	];
```

html页面提交form表单验证：

```html
//表单验证 form-singwaapp 提交的form标签的id/class值，这里面是id值
$("#form-singwaapp").validate({
	rules: {
		// 如果设置为true，对应的标签就是必填项
		title: { //  input标签中name属性对应的名称为title
			required: true,
		},
		small_title: {
			required: true,
		},
		catid: {
			required: true,
		},
		sources_type: {
			required: true,
		},
	},
	onkeyup: false,
	focusCleanup: true,
	success: "valid",
	submitHandler: function(form) {
		singwaapp_save(form); // 需要自定义一个singwaapp_save方法 用来处理抛送请求的哦
	}
});
```

创建一个from提交表单数据的通用singwaapp_save方法 用来处理请求(文件路径/public/static/admin/js/common.js)：

```php
/**
 * 通过用的 from表单中提交的数据的方法
 */
function singwaapp_save(form) {
    // 接收传递过来的数据
    var data = $(form).serialize();
    //调试
    //console.log(data);

    // 获取提交的url地址
    url = $(form).attr('url');

    // 执行ajax 判断返回值并处理 js ajax
    $.post(url, data, function(result){
        if(result.code == 0) {
			// 失败，提示信息，2s后返回
            layer.msg(result.msg, {icon:5, time:2000});
        }else if(result.code == 1) {
			// 成功，跳转的成功页面
            self.location=result.data.jump_url;
        }
    }, 'JSON');
}
```

需要新建model方法下的News文件（文件News继承Base，使用的是Base下的add方法）：

```php
public function add() {
	if(request()->isPost()) {
		$data = input('post.');
		// 数据需要做检验 validate机制小伙伴自行完成

		//入库操作
		try {
			$id = model('News')->add($data);
		}catch (\Exception $e) {
			return $this->result('', 0, '新增失败');
		}
		if($id) {
			return $this->result(['jump_url' => url('news/index')], 1, 'OK');
		} else {
			return $this->result('', 0, '新增失败');
		}
	}else {
		return $this->fetch('', [
			'cats' => config('cat.lists')
		]);
	}
}
```

## 列表页面开发

### 基于TP5分页模式开发普通列表

- 获取数据，然后数据填充模板
- 创建News下创建getNews方法
- 

#### 模式一

html页面中调用：{:pageination($news)}

分页模式（/app/common.php）分页方法（修改分页数量在配置文件中，默认15：config.php）:

```php
function pageination($obj){
    if(!$obj){
        return '';
    }
    $params = request()->param();
    return '<div class="imooc-app">'.$obj->appends($params)->render().'</div>';
}
```

imooc-app 对应的样式(new/index.html)：

```html
<style>
  .imooc-app .pagination li{display:inline; padding-left:10px;}
  .pagination .active{color:red}
  .pagination .disabled{color:#888888}
</style>
```

列表展示方法(controller/News.php)：

```php
    public function index() {
        // 模式一
        $news = model('News')->getNews();
		
		return $this->fetch('', [
            'news' => $news,
        ]);
    }
```

数据处理(model/NewsList.php)：

```php
/**
 * 后台自动化分页
 * @param array $data
 */
public function getNews($data = []) {
	$data['status'] = [
		'neq', config('code.status_delete')
	];
	$order = ['id' => 'desc'];
	// 查询
	$result = $this->where($data)
		->order($order)
		->paginate();

	return $result;
}
```

分类栏目转换（/app/common.php）：

```php
/**
 * 获取栏目名称
 * @param $catId
 */
function getCatName($catId) {
    if(!$catId) {
        return '';
    }
    $cats = config('cat.lists');

    return !empty($cats[$catId]) ? $cats[$catId] : '';
}
```

状态转换（/app/common.php）：

```php
/**
 * Notes: 状态 1是0否
 * @param $str
 * @return string
 */
function isYesNo($str) {
    return $str ? '<span style="color:red"> 是</span>' : '<span > 否</span>';
}
```

#### 模式二：引入laypage

在模式一的基础上更改：

去掉html中的{:pageination($news)}
