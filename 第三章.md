3.3-3.6
## 验证码功能开发

### ThinkPHP5验证码的巧妙使用

1、登录

	首先在admin中的controller中创建Login.php，定位到首页
	
```php
// 登录页面
public function index(){
	return $this->fetch();
}
```	
	
	进入验证码类库vendor/topthink/think-captcha
	找到admin/login/index.html中插入验证码
	
```html
// 方式一： 插入图片点击刷新
<img src="/captcha" alt='验证码' onclick="reloadCode(this)">
// 方式一对应的事件
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="/captcha?id" + Math.random;
	}
</script>

//方式二： 如果上述拿不到图片使用这个：
<img src="{:captcha_src()}" alt='验证码' onclick="reloadCode(this)">
// 方式二对应的事件
<script>
	// 刷新验证码
	function reloadCode(obj){
		obj.src="{:captcha_src()}" + Math.random;
	}
</script>

// 方式三：对应事件直接写在标签里面
<img src="{:captcha_src()}" onclick="this.src='{:captcha_src()}?'+Math.random();" />
```

	配置验证码的宽高：app/config.php 中 增加：
	
```php
'captcha' => [
	'imageH' => 50,
	'imageW' => 200
],
```

### 如何点击验证码图片自动刷新验证码 

	获取验证码进行匹配
```html
// 点击登录提交的模板
<form class='' action="{:url('login/check')}" method='post'>
</form>
```

```php
publuc function check(){
	$data = input('post.');
	if(!captcha_check($data['code'])){
		$this->error("验证码不正确");
	}
}
```

## 登录功能开发

流程：验证码判断 -> 基本信息判定 -> 登录成功/登录失败

```php
// 登录相关业务
publuc function check(){
	if(request()->isPost()){
		$data = input('post.');
		if(!captcha_check($data['code'])){
			$this->error("验证码不正确");
		}
		// 判断信息 username password
		// validate 机制 
		// username 用户名存在与否
		// username+password 用户名或密码错误
		$user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
		// halt($user);
		if(!$user || $user->status != 1){
			$this->error("用户名不存在");
		}
		// 根据添加数据的时候加密方式进行判断密码
		if(md5($data['password'].'_#sing_ty') != $user['password']){
			$this->error("密码不正确");
		}
	}else{
		$this->error("请求方法不正确");
	}
}
```

5： 把密码加密信息放到配置文件中
'_#sing_ty' 为了一后方便设置更改，设置配置文件，app/extra/app.php

```php
return [
    'password_pre_halt' => '_#sing_ty', // 密码加密
];
```

6： 封装类库  把md5加密封装到 IAuth.php 中，同时设置加密配置常量
新建文件common/lib/IAuth.php
```php
namespace app\common\lib;
/**
 * IAuth 相关
 * Class IAuth
 * @package app\common\lib
 */
class IAuth{

    /**
     * Notes: 设置密码
     * @param $data
     * @return string
	 * 如果不加static，可能报错：... should not be called statically
     */
    public static function setPassword($data)
    {
        //return md5($data . '_#sing_ty');
		5： 把密码加密信息放到配置文件中
		return md5($data . config("app.password_pre_halt"));
    }
}
```

7： 更新数据库 登录时间 登录ip地址
8： 完善try{}catch(){}
9： 更新 session
10： 把状态码信息方到配置文件中
新建配置文件 app/extra/code.php

```php
/**
 * 和状态码先关的文案配置
 */
return [
    'status_deleta' => '-1',
    'status_normale' => '1',
    'status_padding' => '0',// 待审
];
```

11：把session存储信息放到配置文件中
新建配置文件 app/extra/admin.php

```php
/**
 * session存储的文案配置
 */
return [
    'session_user' => 'adminuser',
    'session_user_scope' => 'imooc_app_scope',
];
```

最终：

```php
// 登录相关业务
    public function check(){
        if(request()->isPost()){
            $data = input('post.');
            if(!captcha_check($data['code'])){
                $this->error("验证码不正确");
            }
            // 判断信息 username password
            // validate 机制
            // username 用户名存在与否
            // username+password 用户名或密码错误

            // 8： 判断try{}catch(){}
            try {
                $user = model("AdminUser")->get(["username" => $data['username']]); // 判断用户名是否存在
            }catch (\Exception $e){
                $this->error($e->getMessage());
            }
            // halt($user);
            // 10： 把状态码信息方到配置文件中
            if(!$user || $user->status != config('code.status_normal')){
                $this->error("用户名不存在");
            }
            // 根据添加数据的时候加密方式进行判断密码
            // 6： 封装类库 把md5加密封装到 IAuth.php 中，同时设置加密配置常量
            if(IAuth::setPassword($data['password']) != $user['password']){
                $this->error("密码不正确");
            }
            // 7： 更新数据库 登录时间 登录ip地址
            $updata = [
                'last_login_time'=> time(),
                'last_login_ip' => request()->ip(),
            ];
            try{
                model("AdminUser")->save($updata,['id'=>$user->id]);
            }catch (\Exception $e){
                $this->error($e->getMessage());
            }
            // 9： 更新 session
            // 11： 吧session放入文案中
            session(config('admin.session_user'),$user,config('admin.session_user_scope'));
            // $this->success("登录成功","index/index");
			$this->redirect('index/index');
        }else{
            $this->error("请求方法不正确");
        }
    }
```


## 退出：
1、清空session
2、跳转页面

```php
/**
 * Notes: 退出登录逻辑
 * 1、清空session
 * 2、跳转页面
 */
public function logOut(){
		session(null,config('admin.session_user_scope'));
		$this->redirect("login/index");
}
```

查看session是否清空

```php
halt(session(config('admin.session_user'),'',config('admin.session_user_scope')));
```

3.7
## 权限控制

在控制器中创建一个基类：admin/controller/Base.php

```php
namespace app\admin\controller;
use think\Controller;
class Base extends Controller{
    /**
     * Notes:初始化方法
     */
    public function _initialize(){
        // 判定用户是否登录
        $isLogin = $this->isLogin();
        if(!$isLogin){
            return $this->redirect("login/index");
        }
    }

    /**
     * Notes: 判定是否登录
     * @return bool
     */
    public function isLogin(){
        //获取session值
        $user = session(config("admin.session_user"),'',config('admin.session_user_scope'));
        if($user && $user->id){
            return true;
        }else{
            return false;
        }
    }
}
```

更新登录控制器，继承 Base ，同时更新 index 方法、重定义 _initialize() 方法
其他控制器需要判断是否登录过的话，都需要去继承 Base

```php
class Login extends Base
{
	// 如果不从定义的话，因为继承 Base 控制器会导致死循环
	public function _initialize() {
	}
	// 登录页面
	public function index(){
		$isLogin = $this->isLogin();
		if(!$isLogin) {
			return $this->redirect('index/index');
		}else {
			// 如果后台用户已经登录了， 那么我们需要跳到后台页面
			return $this->fetch();
		}
	}
}
```	

# 四、娱乐新闻内容管理

## 表的设计

- id id值
- title 标题
- small_title 短标题
- catid 栏目id
- image 新闻图片地址
- content 内容 text
- description 描述
- is_position 是否推荐 默认0不推荐
- is_head_flgure 是否推荐到轮播图中 默认0不推荐
- is_allowcomments  文章是否允许被评论 默认0不允许
- listorder 排序
- source_type 新闻来源 默认0
- create_time 创建时间
- updata_time 更新时间
- status 状态 默认0

## 上传图片插件准备工作

- 第三方插件：uploadify
- 根据 uploadify 封装 js类库 - image.js

通过百度进入uploadify官网 查看用法

### 引入 uploadify 插件

1、创建一个视图文件 news 包含添加文件add.html 和 index.html
2、创建一个 News 控制器News.php
3、对应的菜单模块里面增加新闻管理, 包含添加管理，连接到：{:url('news/add')}
4、创建类库image.js：public/static/admin/js/image.js
5、下载uploadify放入public/static/admin下

```html
// 使用uploadify 中的按钮样式，在文件_meta的文件中，引入uploadify的css文件
<link rel="stylesheet" type="text/css" href="__STATIC__/admin/uploadify/uploadify.css" />
// 在文件_meta的文件中，定义变量，创建image.js时使用
<script>
	swf = '__STATIC__/admin/uploadify/uploadify.swf';
	image_upload_url = "{:url('image/upload')}";
</script>
```

```js
// image.js 文件内容
$(function() {
	// 对应图片点击按钮的id名称 <input id="file_upload" type="file" multiple="true">
    $("#file_upload").uploadify({
        swf           : swf, //  指的是uploadify下的swf文件：uploadify.swf
        uploader      : image_upload_url, // 上传的路径
        buttonText    : '图片上传', // 按钮的名称
        fileTypeDesc  : 'Image files', // 文件类型描述
        fileObjName   : 'file', // 文件名称
        fileTypeExts  : '*.gif;*.jpg;*.png', // 上传文件类型
        onUploadSuccess : function(file, data, response) { // 上传成功返回数据
            // 我们需要扩展内容
            if(response) {
                var obj = JSON.parse(data); // 返回的json数据，进行json解析
                $('#upload_org_code_img').attr("src", obj.data); // 插入页面中，待展示
                $('#file_upload_image').attr("value", obj.data); // 插入页面中，待提交使用
                $('#upload_org_code_img').show(); // 上传图片显示缩略图
            }
        }
    });
});
```

后台图片上传相关逻辑

```php
namespace app\admin\controller;
use think\Controller;
class Image extends Base
{
    public function upload(){
		//后台图片上传相关逻辑
        $data = [
            'status' => 1,
            'message' => 'OK',
            'data' => 'http://t2.hddhhn.com/uploads/tu/201707/571/106.jpg',
        ];
        echo json_encode($data);
    }
}
```

### 上传到本地

上传本地的缺点：

- 不利于维护和管理
- 访问量多的时候IO操作可能会存在瓶颈

```php
namespace app\admin\controller;
use think\Controller;
use think\Request;
use app\common\lib\Upload;
class Image extends Base
{
    /**
     * 图片上传
     */
    public function upload0() {
        $file = Request::instance()->file('file');
        // 把图片上传到指定的文件夹中 public/upload
        $info = $file->move('upload');
		
		// $info->getPathname() 文件上传之后返回的路径 
        if($info && $info->getPathname()) {
            $data = [
                'status' => 1,
                'message' => 'OK',
                'data' => '/'.$info->getPathname(), // 当前文件路径，不是网上的
            ];
            echo json_encode($data);
        }else{
			echo json_encode(['status' => 0, 'message' => '上传失败']);
		}
    }
}
```

### 图片上传到七牛云

